#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - ca-certificates
  - tzdata
  - perl
  - postfix
  - unattended-upgrades
  - apt-listchanges
  - dnsutils

# Set root password for console access (SSH still disabled over network)
chpasswd:
  list: |
    root:${root_password}
  expire: false

# Disable SSH over network for security, but allow console login
ssh_pwauth: false
disable_root: false

# Configure automatic security updates
apt:
  conf: |
    APT::Periodic::Update-Package-Lists "1";
    APT::Periodic::Unattended-Upgrade "1";
    APT::Periodic::AutocleanInterval "7";
    Unattended-Upgrade::Automatic-Reboot "true";
    Unattended-Upgrade::Automatic-Reboot-Time "03:00";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";

write_files:
  - path: /etc/gitlab-setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "Waiting for volume to be attached..."
      while [ ! -e /dev/disk/by-id/scsi-0HC_Volume_* ]; do
        sleep 2
      done

      VOLUME_DEVICE=$(ls /dev/disk/by-id/scsi-0HC_Volume_* | head -1)
      echo "Found volume: $VOLUME_DEVICE"

      # Check if volume is already formatted
      if ! blkid $VOLUME_DEVICE; then
        echo "Formatting volume..."
        mkfs.ext4 -F $VOLUME_DEVICE
      fi

      # Create mount point
      mkdir -p /var/opt/gitlab

      # Mount volume
      echo "$VOLUME_DEVICE /var/opt/gitlab ext4 discard,nofail,defaults 0 0" >> /etc/fstab
      mount -a

      # Set ownership
      chown -R root:root /var/opt/gitlab

      echo "Volume mounted successfully"

      # Install GitLab
      echo "Installing GitLab CE..."
      curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash

      # Install GitLab without setting password via environment (special chars cause issues)
      EXTERNAL_URL="${gitlab_url}" apt-get install -y gitlab-ce

      # Configure GitLab Registry and settings
      cat >> /etc/gitlab/gitlab.rb <<'EOF'

      # External URLs
      external_url '${gitlab_url}'
      registry_external_url '${registry_url}'

      # Registry settings
      gitlab_rails['registry_enabled'] = true
      registry['enable'] = true

      # Let's Encrypt - DISABLED initially, enabled after DNS propagation
      letsencrypt['enable'] = false

      # Registry Let's Encrypt
      registry_nginx['ssl_certificate'] = "/etc/gitlab/ssl/#{node['fqdn']}.crt"
      registry_nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/#{node['fqdn']}.key"

      # Performance settings
      unicorn['worker_processes'] = 2
      sidekiq['max_concurrency'] = 10
      postgresql['shared_buffers'] = "256MB"

      # Monitoring
      prometheus_monitoring['enable'] = true

      # Security settings - disable new user signups
      gitlab_rails['gitlab_signup_enabled'] = false

      # Disable unused services
      mattermost['enable'] = false
      EOF

      # Replace URL placeholders in gitlab.rb
      sed -i "s|\${gitlab_url}|${gitlab_url}|g" /etc/gitlab/gitlab.rb
      sed -i "s|\${registry_url}|${registry_url}|g" /etc/gitlab/gitlab.rb

      # Initial reconfigure to set up GitLab
      gitlab-ctl reconfigure

      # Set root password using gitlab-rake (handles special characters correctly)
      gitlab-rake "gitlab:password:reset[root]" <<PWDEOF
${gitlab_root_password}
${gitlab_root_password}
PWDEOF

      # Enable Let's Encrypt directly
      echo "Enabling Let's Encrypt..."
      sed -i "s/letsencrypt\['enable'\] = false/letsencrypt['enable'] = true/" /etc/gitlab/gitlab.rb

      # Add Let's Encrypt contact email
      sed -i "/letsencrypt\['enable'\] = true/a letsencrypt['contact_emails'] = ['${letsencrypt_email}']\\nletsencrypt['auto_renew'] = true" /etc/gitlab/gitlab.rb

      # Reconfigure GitLab with Let's Encrypt
      echo "Starting GitLab and obtaining Let's Encrypt certificates..."
      gitlab-ctl reconfigure

      echo "Let's Encrypt certificates obtained successfully!"

      echo "GitLab installation complete!"
      echo "Access GitLab at: ${gitlab_url}"
      echo "Username: root"

runcmd:
  - /etc/gitlab-setup.sh

final_message: "GitLab server is ready!"
